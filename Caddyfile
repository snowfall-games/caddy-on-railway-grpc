{
	# h1 + h2 is enough on the public listener; h2c is for cleartext listeners.
	servers {
		protocols h1 h2 h2c
	}
	debug
}

horde.snowfall.games:443 {
	# Terminate TLS using the Cloudflare Origin cert
	tls /config/certs/cf-origin.crt /config/certs/cf-origin.key

	# Simple health check (plain text)
	handle_path /health {
		respond "OK" 200
	}

	log {
		output stdout
		format console
	}

	# gRPC matcher (HTTP/2 requests with gRPC content-type)
	@grpc {
		header Content-Type *application/grpc*
		protocol h2
	}

	# gRPC → h2c upstream (no TLS between Caddy and app)
	handle @grpc {
		reverse_proxy h2c://{$HORDE_HOST}:5002 {
			transport http {
				versions h2c
			}

			debug
			# TE is HTTP/1.1-specific; not needed for h2
			flush_interval -1
		}
	}

	# Everything else → HTTP upstream
	handle {
		reverse_proxy http://{$HORDE_HOST}:5000
	}
}
