:{$PORT} {
	# Terminate TLS using the Cloudflare Origin cert
	tls /config/certs/cf-origin.crt /config/certs/cf-origin.key

	log {
		output stdout
		format console
		level DEBUG
	}

	# gRPC matcher - test exact match
	@grpc {
		header Content-Type "application/grpc"
	}

	route {
		# Health check endpoint
		handle /health {
			respond "OK" 200
		}

		# gRPC → h2c upstream (no TLS between Caddy and app)  
		handle @grpc {
			reverse_proxy h2c://{$HORDE_HOST}:5002
		}

		# Everything else → HTTP upstream
		handle {
			reverse_proxy http://{$HORDE_HOST}:5000
		}
	}
}
