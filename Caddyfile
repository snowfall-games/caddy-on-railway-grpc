
# gRPC-only subdomain (works around Cloudflare gRPC limitations)
grpc.snowfall.games {
	# Terminate TLS using the Cloudflare Origin cert
	tls /config/certs/cf-origin.crt /config/certs/cf-origin.key
	
	log {
		output stdout
		format console
		level DEBUG
	}
	
	# All traffic to gRPC subdomain goes to gRPC backend
	reverse_proxy h2c://{$HORDE_HOST}:5002 {
		transport http {
			versions h2c
		}
		flush_interval -1
		header_up -Content-Length
		header_up Te "trailers"
	}
}

# Main domain for web traffic
horde.snowfall.games, :{$PORT} {
	# Terminate TLS using the Cloudflare Origin cert
	tls /config/certs/cf-origin.crt /config/certs/cf-origin.key

	log {
		output stdout
		format console
		level DEBUG
	}

	# gRPC matcher (for any gRPC traffic that hits main domain)
	@grpc {
		header Content-Type "application/grpc"
	}

	route {
		# Health check endpoint
		handle /health {
			respond "OK" 200
		}

		# Redirect gRPC traffic to gRPC subdomain
		handle @grpc {
			redir https://grpc.snowfall.games{uri} 307
		}

		# Everything else â†’ HTTP upstream (disable caching)
		handle {
			reverse_proxy http://{$HORDE_HOST}:5000 {
				header_down Cache-Control "no-cache, no-store, must-revalidate"
				header_down Pragma "no-cache"
				header_down Expires "0"
			}
		}
	}
}
