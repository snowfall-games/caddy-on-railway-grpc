:{$PORT} {
	# Terminate TLS using the Cloudflare Origin cert
	tls /config/certs/cf-origin.crt /config/certs/cf-origin.key

	log {
		output stdout
		format console
		level DEBUG
	}

	# gRPC matcher (HTTP/2 requests with gRPC content-type)
	@grpc {
		header Content-Type *application/grpc*
		protocol h2
	}

	route {
		# Health check endpoint
		handle /health {
			respond "OK" 200
		}

		# gRPC → h2c upstream (no TLS between Caddy and app)
		handle @grpc {
			reverse_proxy h2c://{$HORDE_HOST}:5002 {
				transport http {
					versions h2c
				}
				flush_interval -1
			}
		}

		# Everything else → HTTP upstream
		handle {
			reverse_proxy http://{$HORDE_HOST}:5000
		}
	}
}
