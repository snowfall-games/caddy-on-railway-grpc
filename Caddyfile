{
	# We terminate TLS with a Cloudflare Origin Cert provided via env and written to /config/certs
	servers {
		protocols h1 h2 h2c
	}
}

horde.snowfall.games:443 {
	# Health check
	respond /health "Caddy is working" 200

	# Serve TLS using the origin cert
	tls /config/certs/cf-origin.crt /config/certs/cf-origin.key

	# Detect gRPC requests
	@grpc {
		header Content-Type application/grpc*
		protocol grpc
	}

	# gRPC over h2c upstream
	handle @grpc {
		reverse_proxy snowfall-horde.railway.internal:5002 {
			transport http {
				versions h2c 2
			}
		}
	}

	# HTTP upstream
	handle {
		reverse_proxy snowfall-horde.railway.internal:5000
	}
}