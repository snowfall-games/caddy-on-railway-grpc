# Private IP for gRPC (from WARP clients)
10.0.0.100:5002 {
	# No TLS needed for private network traffic
	
	# All traffic to this private IP goes to gRPC backend
	reverse_proxy h2c://{$HORDE_HOST}:5002 {
		transport http {
			versions h2c
		}
		flush_interval -1
		header_up -Content-Length
		header_up Te "trailers"
	}
}

:{$PORT} {
	# Terminate TLS using the Cloudflare Origin cert
	tls /config/certs/cf-origin.crt /config/certs/cf-origin.key

	log {
		output stdout
		format console
		level DEBUG
	}

	# gRPC matcher - test exact match
	@grpc {
		header Content-Type "application/grpc"
	}

	route {
		# Health check endpoint
		handle /health {
			respond "OK" 200
		}

		# gRPC → h2c upstream (TLS terminated by Caddy, forward as cleartext HTTP/2)
		handle @grpc {
			reverse_proxy h2c://{$HORDE_HOST}:5002 {
				transport http {
					versions h2c
				}
				flush_interval -1
				header_up -Content-Length
				header_up Te "trailers"
			}
		}

		# Everything else → HTTP upstream (disable caching)
		handle {
			reverse_proxy http://{$HORDE_HOST}:5000 {
				header_down Cache-Control "no-cache, no-store, must-revalidate"
				header_down Pragma "no-cache"
				header_down Expires "0"
			}
		}
	}
}
