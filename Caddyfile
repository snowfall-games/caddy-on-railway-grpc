{
	# We terminate TLS with a Cloudflare Origin Cert provided via env and written to /config/certs
	servers {
		protocols h1 h2 h2c
	}
	debug
}

horde.snowfall.games:{$PORT} {
	# Health check
	respond /health "Caddy is working" 200

	# Serve TLS using the origin cert
	tls /config/certs/cf-origin.crt /config/certs/cf-origin.key

	# Access logs for visibility
	log {
		output stdout
		format console
	}

	# Detect gRPC requests
	@grpc {
		header Content-Type application/grpc*
		header TE trailers
	}

	# gRPC over h2c upstream
	handle @grpc {
		reverse_proxy {$HORDE_HOST}:5002 {
			transport http {
				versions h2c
			}
			# Ensure upstream sees proper authority/host for gRPC
			header_up Host {upstream_hostport}
			header_up TE trailers
			flush_interval -1
		}
	}

	# HTTP upstream
	handle {
		reverse_proxy {$HORDE_HOST}:5000 {
			header_up Host {upstream_hostport}
		}
	}
}