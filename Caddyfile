:{$PORT} {
	# Terminate TLS using the Cloudflare Origin cert
	tls /config/certs/cf-origin.crt /config/certs/cf-origin.key

	log {
		output stdout
		format console
		level DEBUG
	}

	# gRPC matcher - test exact match
	@grpc {
		header Content-Type "application/grpc"
	}

	route {
		# Health check endpoint
		handle /health {
			respond "OK" 200
		}

		# gRPC → h2c upstream (no TLS between Caddy and app)  
		handle @grpc {
			reverse_proxy {$HORDE_HOST}:5002 {
				transport http {
					versions h2c
					read_timeout 0
					write_timeout 0
					dial_timeout 10s
				}
				header_up -Content-Length
				header_up Connection {http.request.header.connection}
				header_up Upgrade {http.request.header.upgrade}
				flush_interval -1
			}
		}

		# Everything else → HTTP upstream (disable caching)
		handle {
			reverse_proxy http://{$HORDE_HOST}:5000 {
				header_down Cache-Control "no-cache, no-store, must-revalidate"
				header_down Pragma "no-cache"
				header_down Expires "0"
			}
		}
	}
}
