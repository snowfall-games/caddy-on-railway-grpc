:{$PORT} {
	# Terminate TLS using the Cloudflare Origin cert
	tls /config/certs/cf-origin.crt /config/certs/cf-origin.key

	log {
		output stdout
		format console
		level DEBUG
	}

	# gRPC matcher
	@grpc {
		header Content-Type application/grpc*
	}

	route {
		# Health check endpoint
		handle /health {
			respond "OK" 200
		}

		# gRPC → h2c upstream (no TLS between Caddy and app)
		handle @grpc {
			reverse_proxy {$HORDE_HOST}:5002 {
				transport http {
					versions h2c
				}
				# Preserve gRPC headers and disable buffering
				header_up -Content-Length
				flush_interval -1
			}
		}

		# Everything else → HTTP upstream
		handle {
			reverse_proxy http://{$HORDE_HOST}:5000
		}
	}
}
